package cmd

import (
	"context"
	"fmt"
	"net/http"
	"os"

	rest "github.com/google/go-github/v41/github"
	"github.com/gookit/color"
	graphql "github.com/shurcooL/githubv4"
	"github.com/spf13/cobra"
	"golang.org/x/oauth2"
)

var (
	token        string
	organization string
	repositories []Repository

	repoQuery struct {
		Organization struct {
			Repositories struct {
				PageInfo struct {
					EndCursor   graphql.String
					HasNextPage bool
				}
				Nodes []Repository
			} `graphql:"repositories(first: 100, after: $page, orderBy: {field: NAME, direction: ASC})"`
		} `graphql:"organization(login: $login)"`
	}

	httpClient    *http.Client
	restClient    *rest.Client
	graphqlClient *graphql.Client

	ctx = context.Background()

	rootCmd = &cobra.Command{
		Use:     "ghec-vulnerability-alerts-report",
		Short:   "TODO",
		PreRun:  GetOrgRepos,
		RunE:    Run,
		Version: "0.0.0-development",
	}
)

// Repository unexported
type Repository struct {
	Name string
}

// Execute adds all child commands to the root command and sets flags
func Execute() {
	if err := rootCmd.Execute(); err != nil {
		fmt.Println(err)
		os.Exit(1)
	}
}

func init() {
	cobra.OnInitialize(initClient)

	rootCmd.PersistentFlags().StringVarP(
		&token, "token", "t", "GITHUB_TOKEN",
		"github.com personal access token",
	)
	token = os.Getenv("GITHUB_TOKEN")

	rootCmd.PersistentFlags().StringVarP(
		&organization, "organization", "o", "",
		"github.com organization",
	)
}

// initClient creates the github.com REST (v3) and GraphQL (v4) clients
func initClient() {
	src := oauth2.StaticTokenSource(
		&oauth2.Token{AccessToken: token},
	)
	httpClient = oauth2.NewClient(ctx, src)

	graphqlClient = graphql.NewClient(httpClient)
	restClient = rest.NewClient(httpClient)
}

func Run(cmd *cobra.Command, args []string) error {
	for _, repo := range repositories {
		_, res, err := restClient.Repositories.GetVulnerabilityAlerts(ctx, organization, repo.Name)

		if err != nil {
			fmt.Println(err)
			os.Exit(1)
		}

		if res.StatusCode == 204 {
			color.Info.Tips("\t%s/%s has vulnerability alerts enabled", organization, repo.Name)
		} else {
			color.Error.Prompt("\t%s/%s has vulnerability alerts not enabled", organization, repo.Name)
		}
	}

	return nil
}

func GetOrgRepos(cmd *cobra.Command, args []string) {
	variables := map[string]interface{}{
		"login": graphql.String(organization),
		"page":  (*graphql.String)(nil),
	}

	for {
		err := graphqlClient.Query(ctx, &repoQuery, variables)

		if err != nil {
			fmt.Println(err)
			os.Exit(1)
		}

		repositories = append(repositories, repoQuery.Organization.Repositories.Nodes...)

		// break on last page
		if !repoQuery.Organization.Repositories.PageInfo.HasNextPage {
			break
		}

		variables["page"] = graphql.NewString(repoQuery.Organization.Repositories.PageInfo.EndCursor)
	}
}
